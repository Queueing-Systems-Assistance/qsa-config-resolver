name: CI/CD

env:
  TARGET_BRANCH: master
  PROJECT_MAJOR_VERSION: 1
  PROJECT_MINOR_VERSION: 1

on:
  push:
    branches:
      - master
      - feature/QSA-*

jobs:
  versioning:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      BRANCH_NAME: ${{ steps.versioning.outputs.BRANCH_NAME }}
      RELEASE_VERSION: ${{ steps.versioning.outputs.RELEASE_VERSION }}
    steps:
      - name: Versioning
        id: versioning
        shell: bash
        run: |
          if [[ "${BRANCH_NAME}" != "${{env.TARGET_BRANCH}}" ]]; then
            BRANCH_NAME=$(echo "$GITHUB_REF_NAME" | sed s#/#-#g | sed s/[.]/_/g | sed s#-#_#g | awk '{print $1""}')
          fi
          RELEASE_VERSION=${{env.PROJECT_MAJOR_VERSION}}.${{env.PROJECT_MINOR_VERSION}}.${GITHUB_RUN_NUMBER}
          if [[ "${BRANCH_NAME}" != "${{env.TARGET_BRANCH}}" ]]; then
            RELEASE_VERSION="${RELEASE_VERSION}_${BRANCH_NAME}"
          fi
          echo "BRANCH_NAME:" "${BRANCH_NAME}"
          echo "RELEASE_VERSION:" "${RELEASE_VERSION}"
          echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "RELEASE_VERSION=${RELEASE_VERSION}" >> $GITHUB_OUTPUT
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    needs: [ versioning ]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      - name: Build
        run: |
          chmod +x gradlew
          ./gradlew -x checkstyleMain -x checkstyleTest build -Prelease.version="${{ needs.versioning.outputs.RELEASE_VERSION }}" --no-daemon
      - name: Save Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: qsa-config-resolver
          path: ./build/
          retention-days: 7
  static-analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    needs: [ versioning ]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      - name: Checkstyle validation
        run: |
          chmod +x gradlew
          ./gradlew checkstyleMain checkstyleTest -Prelease.version="${{needs.versioning.outputs.RELEASE_VERSION}}" --no-daemon
  release:
    #if: contains( github.ref, '${{env.TARGET_BRANCH}}')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    needs: [ versioning, build, static-analysis ]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      - name: Retrieve Artifacts
        uses: actions/download-artifact@v3
        with:
          name: qsa-config-resolver
          path: ./build/
      - name: Release Artifact
        run: |
          chmod +x gradlew
          ./gradlew publish -Prelease.version="${{needs.versioning.outputs.RELEASE_VERSION}}" -Pci.token="${{secrets.CI_GITHUB_TOKEN}}" -Pci.username="${{secrets.CI_GITHUB_USERNAME}}" --no-daemon
      - name: Git Tagging
        run: |
          git config --global user.email "ci@github.com"
          git config --global user.name "GitHub CI"
          git tag -a -f "${{needs.versioning.outputs.RELEASE_VERSION}}" -m "${{needs.versioning.outputs.RELEASE_VERSION}}"
          git push -f "https://${CI_GITHUB_TOKEN}@github.com/${{env.GITHUB_REPOSITORY}}" refs/tags/"${{needs.versioning.outputs.RELEASE_VERSION}}"
      #- name: Jira Notify